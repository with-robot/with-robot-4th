# 🚧 시나리오 1: 장애물 회피 및 경로 재계획

## 📋 시나리오 설명

**목표**: 로봇이 목표 지점으로 이동하는 중 예상치 못한 장애물을 발견하고 경로를 다시 계획하여 목표에 도달합니다.

## ✨ 구현된 기능

### 1. 자동 장애물 감지
- `set_target_position()` 호출 시 자동으로 장애물 체크
- 장애물 발견 시 즉시 경로 재계획

### 2. 지능형 경로 재계획
- 장애물 위치 분석
- 우회 경로 자동 생성 (waypoints)
- 안전 거리 확보 (기본 0.5m)

### 3. LLM 통합
- 자연어로 장애물 추가 및 이동 명령
- GPT-4가 자동으로 코드 생성

### 4. 음성 피드백
- 장애물 발견 시 음성 알림: "장애물을 발견했습니다. 경로를 재계획하는 중입니다."
- ElevenLabs TTS 자동 재생

---

## 🚀 빠른 시작

### 방법 1: 자동 테스트 스크립트

```bash
cd /Users/chloepark/Desktop/with-robot-4th/robot
mjpython test_scenario1.py
```

**테스트 내용:**
1. 기본 장애물 감지 및 회피
2. LLM 자연어 명령으로 장애물 회피
3. 다중 장애물 환경 테스트

### 방법 2: 음성 제어 데모

```bash
cd /Users/chloepark/Desktop/with-robot-4th/robot
./start_voice_demo.sh
```

브라우저에서 http://localhost:8800/ui 접속

---

## 🎬 데모 시연 방법

### 데모 1: 텍스트 입력 (30초)

**입력창에 입력:**
```
장애물을 (1.0, 0.5) 위치에 추가하고, 목표 지점 (1.5, 0.5)로 이동해줘
```

**예상 결과:**
```
✅ Obstacle added at (1.00, 0.50), radius=0.30

🚧 장애물 발견! 경로를 재계획합니다...
📍 Detour waypoints generated: 3 points
   WP1: (0.50, 1.00)
   WP2: (1.30, 1.00)
   WP3: (1.50, 0.50)

🔄 우회 경로 1/3: (0.50, 1.00)
  ✓ Reached target
🔄 우회 경로 2/3: (1.30, 1.00)
  ✓ Reached target
🔄 우회 경로 3/3: (1.50, 0.50)
  ✓ Reached target

✅ 우회 완료! 목표 도달
```

### 데모 2: 음성 입력 (1분) ⭐

**시연 순서:**

1. **🎤 버튼 클릭**

2. **음성 명령:**
   ```
   "장애물을 0.5, 1.0 위치에 추가하고 목표 지점 1.5, 1.5로 이동해줘"
   ```

3. **로봇 응답 (음성):**
   ```
   "장애물 추가 후 목표 지점으로 이동하겠습니다"
   ```

4. **코드 자동 생성 및 실행**

5. **장애물 감지 시 음성 알림:**
   ```
   🔊 "장애물을 발견했습니다. 경로를 재계획하는 중입니다"
   ```

6. **우회 경로로 목표 도달**

### 데모 3: 다중 장애물 (1분 30초)

**음성 명령:**
```
"3개의 장애물을 추가해줘.
첫 번째는 0.5, 0.5,
두 번째는 1.5, 0.5,
세 번째는 1.0, 1.5.
그리고 목표 지점 2.0, 2.0으로 이동"
```

**기대 효과:**
- 복잡한 장애물 환경에서도 자동 경로 계획
- 다단계 우회 경로 생성
- 안전한 목표 도달

---

## 📝 주요 API 함수

### 장애물 관리

```python
# 장애물 추가
add_obstacle(x, y, radius=0.3)

# 장애물 정보 확인
print(get_obstacle_info())

# 모든 장애물 제거
clear_obstacles()
```

### 로봇 이동 (자동 장애물 회피)

```python
# 기본 이동 - 장애물 자동 감지 및 회피
set_target_position(x, y, theta, wait=True)

# 예제
set_target_position(1.5, 0.5, 0, wait=True)
# → 장애물 발견 시 자동으로 우회 경로 생성
```

---

## 🎯 데모 팁

### 1. 효과적인 장애물 배치

```python
# 직선 경로 차단
add_obstacle(1.0, 0.0, radius=0.3)
set_target_position(2.0, 0.0, 0, wait=True)

# 좁은 통로 만들기
add_obstacle(1.0, 0.3, radius=0.2)
add_obstacle(1.0, -0.3, radius=0.2)
set_target_position(2.0, 0.0, 0, wait=True)
```

### 2. 음성 명령 예시

**간단한 명령:**
- "장애물 추가해줘"
- "목표 지점으로 이동"
- "장애물 제거해줘"

**복잡한 명령:**
- "1미터 앞에 장애물을 놓고 2미터 지점으로 가줘"
- "원형 경로로 이동하면서 장애물을 피해가줘"
- "정사각형을 그리는데 중간에 장애물이 있으면 우회해줘"

### 3. 시각적 효과

MuJoCo 창에서:
- 로봇의 우회 경로 움직임 관찰
- 장애물 회피 시 부드러운 경로 변경
- 목표 도달 후 정지

---

## 🔍 기술적 세부사항

### 경로 재계획 알고리즘

1. **장애물 감지**
   ```python
   obstacle = obstacle_manager.check_path(x, y)
   ```

2. **우회 경로 생성**
   - 현재 위치와 목표 사이의 방향 계산
   - 장애물에 수직인 방향으로 우회점 생성
   - 안전 거리(반지름 + 0.5m) 확보

3. **Waypoint 생성**
   ```
   현재 위치 → WP1 (장애물 옆) → WP2 (장애물 지나침) → 목표
   ```

4. **순차 이동**
   - 각 waypoint를 순서대로 방문
   - PD 컨트롤러로 정확한 위치 제어

### 음성 피드백 시스템

```python
# code_repository.py
if obstacle:
    if voice_callback:
        voice_callback("장애물을 발견했습니다. 경로를 재계획하는 중입니다.")
```

---

## 🐛 문제 해결

### 장애물이 감지되지 않음
- 장애물 반지름 확인 (기본 0.3m)
- 목표 지점이 장애물 영역 안에 있는지 확인
- `get_obstacle_info()`로 장애물 위치 확인

### 우회 경로가 작동하지 않음
- `wait=True` 사용 확인
- 시뮬레이터가 실행 중인지 확인
- 터미널 로그에서 우회 경로 생성 확인

### 음성이 재생되지 않음
- ElevenLabs API 키 설정 확인
- Chrome 브라우저 사용 확인
- 볼륨 설정 확인

---

## 📊 성능

- **장애물 감지**: 즉시 (O(n), n=장애물 수)
- **경로 재계획**: ~0.1초
- **우회 이동**: 장애물 크기에 따라 3-5초
- **음성 생성**: 2-3초 (ElevenLabs API)

---

## 🎉 성공 기준

✅ 장애물을 자동으로 감지
✅ 우회 경로를 자동으로 생성
✅ 목표 지점에 안전하게 도달
✅ 음성 피드백 제공
✅ LLM 자연어 명령 이해

---

## 📁 관련 파일

```
robot/
├── obstacle_manager.py          # 장애물 관리 시스템
├── code_repository.py           # 장애물 회피 통합 (set_target_position)
├── llm_agent.py                 # LLM 장애물 예제 포함
├── llm_voice_full.py            # 음성 피드백 통합
├── test_scenario1.py            # 자동 테스트 스크립트
└── SCENARIO1_DEMO.md            # 이 문서
```

---

## 🚀 다음 단계

시나리오 1 완료 후:
- 시나리오 2: (예정)
- 시나리오 3: (예정)
- 시나리오 4: (예정)
- 시나리오 5: (예정)

---

**시나리오 1 구현 완료! 데모 준비 완료!** 🎉🚧🤖
